<!DOCTYPE html>
<html>
<head>
    <title>Cart Error Test</title>
</head>
<body>
    <h1>Test Cart API Error Handling</h1>
    <button onclick="testCartAPI()">Test Add Size L + Blue (Should Fail)</button>
    <button onclick="testCartAPISuccess()">Test Add Size M + White (Should Work)</button>
    
    <div id="result"></div>

    <script>
        async function testCartAPI() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing Size L + Blue (out of stock)...';
            
            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: 'test_session_' + Date.now(),
                        productId: '5',
                        colorId: 63, // Blue
                        sizeId: 69,  // Size L (0 stock)
                        quantity: 1,
                        name: 'test2',
                        price: 2000,
                        colorName: 'Blue',
                        sizeName: 'L',
                        imageUrl: '/uploads/products/test.jpg'
                    })
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('Raw response text:', responseText);
                console.log('Response text length:', responseText.length);
                
                let data;
                try {
                    data = responseText ? JSON.parse(responseText) : {};
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    data = { error: `Parse failed: ${responseText}` };
                }
                
                resultDiv.innerHTML = `
                    <h3>Result for Size L + Blue:</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Raw Response:</strong> ${responseText}</p>
                    <p><strong>Parsed Data:</strong> ${JSON.stringify(data, null, 2)}</p>
                    <p><strong>Error Message:</strong> ${data.error || 'No error message'}</p>
                `;
                
            } catch (error) {
                console.error('Request failed:', error);
                resultDiv.innerHTML = `<p style="color: red;">Request failed: ${error.message}</p>`;
            }
        }
        
        async function testCartAPISuccess() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing Size M + White (should work)...';
            
            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: 'test_session_' + Date.now(),
                        productId: '5',
                        colorId: 64, // White
                        sizeId: 67,  // Size M (2 stock)
                        quantity: 1,
                        name: 'test2',
                        price: 2000,
                        colorName: 'White',
                        sizeName: 'M',
                        imageUrl: '/uploads/products/test.jpg'
                    })
                });
                
                const responseText = await response.text();
                console.log('Success response:', responseText);
                
                let data;
                try {
                    data = responseText ? JSON.parse(responseText) : {};
                } catch (parseError) {
                    data = { error: `Parse failed: ${responseText}` };
                }
                
                resultDiv.innerHTML = `
                    <h3>Result for Size M + White:</h3>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Success:</strong> ${response.ok ? 'Yes' : 'No'}</p>
                    <p><strong>Data:</strong> ${JSON.stringify(data, null, 2)}</p>
                `;
                
            } catch (error) {
                console.error('Request failed:', error);
                resultDiv.innerHTML = `<p style="color: red;">Request failed: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>